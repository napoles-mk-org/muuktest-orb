description: >
  MuukTest Playwright executor with Circle CI on Github pull requests

docker:
  - image: cimg/base:stable

parameters:

  t:
    type: string
    description: "Test case id or hastag name"

  p:
    type: enum
    default: tag
    enum: [tag, hashtag]
    description: "Set either tag or hastag regarding t value"

  browser:
    type: enum
    default: chromium
    enum: [chromium, firefox]
    description: "Set either from chrome or firefox to run the scritp on"

  muuk_key:
    type: string
    description: "MuukTest key.pub value"

steps:
  - run:
      name: Pass Inputs to Shell
      command: |
        export MUUKTEST_KEY=<< parameters.muuk_key >>
        export TAG_PROPERTY=<< parameters.p >>
        export TAG_VALUE=<< parameters.t >>
        export MUUKTEST_BROWSER=<< parameters.browser >>
        mkdir -p executor

  - run:
      name: Installing dependencies
      command: <<include(scripts/install_dependencies.sh)>>

  - run:
      name: Retrieve MuukTest config files and Test scripts
      command: <<include(scripts/get_config_and_tests.sh)>>

  - run:
      name: Installing PW
      command: |
        cd executor || { echo "Failure: executor directory not found!"; exit 1; }
        npm install -D @playwright/test
        npx playwright install --with-deps $MUUKTEST_BROWSER
        npm install axios
        npm install archiver

  - run:
      name: Execute MuukTest E2E
      command: |
        cd executor || { echo "Failure: executor directory not found!"; exit 1; }
        npx playwright test --workers=3 --project=$MUUKTEST_BROWSER
