description: >
  MuukTest Playwright executor with Circle CI on Github pull requests.

docker:
  - image: cimg/node:20.9
    environment:
      MUUKTEST_TAG_PROPERTY: << parameters.p >>
      MUUKTEST_TAG_VALUE: << parameters.t >>
      MUUKTEST_BROWSER: << parameters.browser >>

parameters:

  t:
    type: string
    description: "Test case id or hashtag name."

  p:
    type: enum
    default: tag
    enum: [tag, hashtag]
    description: "Set either tag or hastag according value on t parameter."

  browser:
    type: enum
    default: chromium
    enum: [chromium, firefox]
    description: "Set either from chrome or firefox to run the script on."

  muuk_key:
    default: MUUKTEST_KEY
    description: "Name of the env var with your MuukTest key.pub account value. This var should be set on CircleCi settings."
    type: env_var_name

steps:
  - run:
      name: Init
      command: |
        mkdir -p executor
        cd executor
        MUUKTEST_KEY_INTERNAL=${<< parameters.muuk_key >>}
        printf '{ "key": "%s"}' "$MUUKTEST_KEY_INTERNAL" > file.json
        cat file.json

  - run:
      name: Installing libraries dependencies
      command: sudo apt-get update && sudo apt-get install -y unzip

  - run:
      name: Retrieve MuukTest config files and Test scripts
      command: <<include(scripts/get_pw_config_and_tests.sh)>>

  - run:
      name: Installing PW and required packages
      command: <<include(scripts/install_pw_and_requirements.sh)>>


  - run:
      name: Execute MuukTest E2E
      command: |
        cd executor || { echo "Failure: executor directory not found!"; exit 1; }
        npx playwright test --workers=3 --project=$MUUKTEST_BROWSER
